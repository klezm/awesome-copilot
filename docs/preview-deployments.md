# PR Preview Deployments

This document explains how pull request preview deployments work in this repository using GitHub Actions with dual deployment targets.

## Overview

When you create a pull request, a unified GitHub Actions workflow automatically builds your changes and conditionally deploys them to both GitHub Pages (for production) and Vercel (for preview deployments). This approach provides preview URLs for reviewers while maintaining the existing GitHub Pages deployment for the main site.

## How It Works

### Unified GitHub Actions Workflow

The deployment process is handled by the `.github/workflows/deploy-pages.yml` workflow with three separate jobs:

1. **Trigger**: Runs on every push to `main` branch and on all pull requests
2. **Build Job**: Executes the standard build commands once:
   ```bash
   npm run build
   npm run build:website
   ```
3. **Deploy-Vercel Job**: Runs independently to handle Vercel deployments (if Vercel secrets are configured)
4. **Deploy-Pages Job**: Runs independently to deploy to GitHub Pages (when merging to `main` branch)
5. **Preview URLs**: Posts Vercel preview URLs as comments on pull requests
6. **Automatic Updates**: Every new push triggers fresh deployments

### Benefits of Unified Workflow

This unified approach with separate build and deployment jobs provides several advantages:

- **Efficiency**: Single build process serves both deployment targets
- **Separation of Concerns**: Build, Vercel deployment, and GitHub Pages deployment run as independent jobs
- **Consistency**: Same build artifacts used for both GitHub Pages and Vercel
- **Resource Optimization**: Reduces CI/CD time and resource usage while maintaining modularity
- **Flexibility**: Vercel previews are optional - workflow works even without Vercel secrets
- **Maintainability**: Clear separation between build and deployment responsibilities

### Vercel Configuration

The repository uses `vercel.json` for static configuration:

```json
{
  "version": 2,
  "buildCommand": "npm run build && npm run build:website",
  "outputDirectory": "docs",
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/static-build",
      "config": { "distDir": "docs" }
    }
  ],
  "routes": [
    { "src": "(.*)", "dest": "/$1" }
  ]
}
```

This configuration serves the built files from the `docs` directory with proper routing.

## For Contributors

### Using Preview Deployments

1. **Create a PR**: Open a pull request with your changes
2. **Wait for Workflow**: GitHub Actions will automatically start building and deploying
3. **Check Status**: Monitor the workflow status in the "Actions" tab or PR checks
4. **Access Preview**: Click the preview URL posted by the workflow bot in PR comments
5. **Test Changes**: Verify your changes work correctly in the live preview
6. **Automatic Updates**: New pushes automatically trigger updated previews

### Preview URLs

Preview URLs are generated by Vercel and posted as comments on pull requests. They typically follow this pattern:
```
https://awesome-copilot-{unique-hash}.vercel.app
```

### Workflow Status

You can monitor deployment status in several ways:
- **PR Checks**: Look for the "Deploy Website" check with three separate jobs (build, deploy-vercel, deploy-pages) in the PR
- **Actions Tab**: View detailed logs for each job in the repository's Actions tab  
- **PR Comments**: The deploy-vercel job posts Vercel preview URLs and status updates

## For Maintainers

### Required Secrets (Optional for Vercel)

The workflow has built-in support for Vercel preview deployments, but it's **optional**. If Vercel secrets are not configured, the workflow will still run successfully and deploy to GitHub Pages.

For Vercel preview deployments, configure these GitHub repository secrets:

1. **`VERCEL_TOKEN`**: Personal access token from Vercel
   - Go to [Vercel Account Settings](https://vercel.com/account/tokens)
   - Create a new token with appropriate permissions
   - Add it as a repository secret

2. **`VERCEL_ORG_ID`**: Your Vercel organization ID
   - Found in your Vercel organization settings
   - Or run `vercel whoami` locally after linking the project

3. **`VERCEL_PROJECT_ID`**: The project ID for this repository
   - Found in your Vercel project settings
   - Or in the `.vercel/project.json` file after linking

**Note**: The workflow checks for the presence of `VERCEL_TOKEN` and only runs the deploy-vercel job if it's available. This allows for flexible configuration where some forks or environments may not need Vercel previews.

### Setting Up Secrets

1. Go to your repository's **Settings** → **Secrets and variables** → **Actions**
2. Click **New repository secret**
3. Add each of the required secrets listed above

### Vercel Project Setup

Before the workflow can run successfully:

1. **Link Project**: Connect your repository to a Vercel project
   ```bash
   # Locally, in the repository
   vercel link
   ```

2. **Configure Build Settings**: In Vercel dashboard, ensure:
   - Framework preset: "Other"
   - Build command: `npm run build && npm run build:website`
   - Output directory: `docs`
   - Install command: `npm ci`

### Managing Deployments

#### Monitoring

- **GitHub Actions**: Check workflow runs in the Actions tab
- **Vercel Dashboard**: Monitor deployments, usage, and logs
- **PR Comments**: Review automated status updates

#### Troubleshooting

Common issues and solutions:

1. **Secret Configuration Errors**
   - Verify all three secrets are correctly set
   - Check that the Vercel token has appropriate permissions
   - Ensure project is properly linked to Vercel

2. **Build Failures**
   - Check GitHub Actions logs for detailed error messages
   - Verify build commands work locally: `npm ci && npm run build && npm run build:website`
   - Check for missing dependencies or environment issues

3. **Deployment Failures**
   - Verify Vercel project settings match workflow expectations
   - Check that the output directory (`docs`) contains the built files
   - Ensure Vercel project is not suspended or has quota issues

4. **Missing Preview Comments**
   - Check that the workflow completed successfully
   - Verify GitHub token permissions for posting comments
   - Check if rate limits or API issues are affecting comment posting

### Workflow Customization

The workflow can be customized by editing `.github/workflows/deploy-pages.yml`:

- **Build Commands**: Modify the build steps if your process changes
- **Environment Variables**: Add additional environment variables as needed
- **Deployment Conditions**: Adjust when deployments are triggered
- **Comment Format**: Customize the preview URL comment format
- **Platform Configuration**: Enable/disable GitHub Pages or Vercel deployments

## Security Considerations

### Environment Variables

- **Production Secrets**: Not available in preview deployments by default
- **Preview Variables**: Set preview-specific variables in Vercel dashboard
- **Sensitive Data**: Never commit secrets to the repository

### Access Control

- **Preview URLs**: Publicly accessible by default
- **Vercel Authentication**: Configure in Vercel dashboard if needed
- **Repository Secrets**: Properly manage access to deployment secrets

### Token Security

- **Vercel Token**: Use tokens with minimal required permissions
- **Rotation**: Regularly rotate access tokens
- **Monitoring**: Monitor token usage in Vercel dashboard

## Best Practices

### For Contributors

1. **Local Testing**: Always test `npm run build && npm run build:website` locally
2. **Monitor Workflows**: Check that deployments complete successfully
3. **Preview Testing**: Thoroughly test functionality in preview environments
4. **Resource Awareness**: Be mindful of build times and deployment frequency

### For Reviewers

1. **Use Preview URLs**: Test changes in the live preview environment
2. **Cross-Platform Testing**: Check desktop and mobile compatibility
3. **Performance Validation**: Verify loading times and functionality
4. **Link Testing**: Ensure all navigation and external links work correctly

### For Maintainers

1. **Secret Management**: Regularly audit and rotate deployment secrets
2. **Cost Monitoring**: Track Vercel usage and deployment costs
3. **Workflow Maintenance**: Keep actions and dependencies up to date
4. **Error Monitoring**: Set up alerts for deployment failures

## Additional Resources

- [Vercel CLI Documentation](https://vercel.com/docs/cli)
- [GitHub Actions for Vercel](https://vercel.com/docs/git/vercel-for-github#using-github-actions)
- [Repository Workflow](.github/workflows/deploy-vercel.yml)
- [Vercel Configuration](../vercel.json)